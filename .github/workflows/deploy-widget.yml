name: Deploy Widget SDK

on:
  push:
    branches: [ "production" ]
    paths:
      - 'widget-sdk/**'

env:
  AWS_REGION: ${{ vars.AWS_REGION }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # Required for OIDC
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: ./widget-sdk
        run: npm ci

      - name: Build
        working-directory: ./widget-sdk
        run: npm run build

      - name: Test
        working-directory: ./widget-sdk
        run: npm run test || echo "Tests skipped if not configured"
        continue-on-error: true

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get CloudFront Distribution ID
        id: get-cf-id
        run: |
          # Try to get from Terraform output first
          if [ -f "terraform/terraform.tfstate" ] || [ -f "../terraform/terraform.tfstate" ]; then
            echo "Getting CloudFront ID from Terraform..."
            DIST_ID=$(cd terraform && terraform output -raw cloudfront_distribution_id 2>/dev/null || echo "")
          fi
          
          # If not found, try to find by alias or comment
          if [ -z "$DIST_ID" ]; then
            echo "Searching AWS for CloudFront distribution with alias cdn.scenaro.io..."
            DIST_ID=$(aws cloudfront list-distributions \
              --query "DistributionList.Items[?Aliases.Items[?@=='cdn.scenaro.io']].Id" \
              --output text 2>/dev/null || echo "")
          fi
          
          # If still not found, try by bucket name
          if [ -z "$DIST_ID" ]; then
            echo "Searching by S3 bucket origin..."
            DIST_ID=$(aws cloudfront list-distributions \
              --query "DistributionList.Items[?Origins.Items[?DomainName=='scenaro-widget-sdk-cdn.s3.${AWS_REGION}.amazonaws.com' || contains(DomainName, 'scenaro-widget-sdk-cdn')]].Id" \
              --output text 2>/dev/null || echo "")
          fi
          
          if [ -z "$DIST_ID" ]; then
            echo "::warning::CloudFront distribution not found. Cache invalidation will be skipped."
            echo "distribution_id=" >> $GITHUB_OUTPUT
          else
            echo "Found CloudFront Distribution ID: $DIST_ID"
            echo "distribution_id=$DIST_ID" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to S3
        working-directory: ./widget-sdk
        run: |
          aws s3 sync dist/ s3://scenaro-widget-sdk-cdn/ \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "runtime/*" \
            --exclude "*.html"
          
          # Runtime files with shorter cache
          aws s3 sync dist/runtime/ s3://scenaro-widget-sdk-cdn/runtime/ \
            --delete \
            --cache-control "public, max-age=3600"

      - name: Invalidate CloudFront cache
        if: steps.get-cf-id.outputs.distribution_id != ''
        run: |
          echo "Invalidating CloudFront cache for distribution: ${{ steps.get-cf-id.outputs.distribution_id }}"
          aws cloudfront create-invalidation \
            --distribution-id ${{ steps.get-cf-id.outputs.distribution_id }} \
            --paths "/*"
